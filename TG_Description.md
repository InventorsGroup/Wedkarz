# Scope

This document describes method of generating double tone effect alert for fishing bite alarm.
This document doesn't present complete implementation solution.
All code fragments presented, are written in ANSI C, for STM8L architecture.
Piezo buzzer was connected to PWM output, through transistor (amplifier) in LC circuit with ferrite bead.

## Double tone effect

The feature covers voice notification generated by buzzer, embedded in the device.
Tones are being toggled between two frequencies and volume levels while allerting the user.

Volume levels are fixed to frequencies, and pairs of these are preprogrammed and stored in device's memory, to be chosen by user during configuration.

Tone lengths sould be experimentaly delimitted individually for every tone, to create unique, plesant sound feeling.

Tone sequence goes as follows:

  `Tone[x]` & `Volume[x]` -> `Tone[y]` & `Volume[y]` -> `Tone[x]` & `Volume[x]` -> `Tone[y]` & `Volume[y]` -> (...)
 
## Presented solution

In presented solution, impulses from bite detection module, were simulated by interrupt.
Timer 4 is responsible for this action.

```c
NTERRUPT_HANDLER(TIM4_UPD_OVF_TRG_IRQHandler, 25)
{
  if (BuzzerTrigger == 0)  
  {
    if (BuzzerOn == TRUE) BuzzerTrigger = 1;
  }
  else 
  {
    BuzzerTrigger = 0;
  }
  TIM4_ClearITPendingBit(TIM4_IT_Update);
}
```

Variable BuzzerTrigger is used further.

Timer 2 handles tone length regulation and tone toggling. It's ISR handles incrementing vairable, and decision of turning the tone on or off based on it's comparision with given value. 

Below ISR is triggered every 1ms.

```c
INTERRUPT_HANDLER(TIM2_UPD_OVF_TRG_BRK_USART2_TX_IRQHandler, 19)
{
  /* In order to detect unexpected events during development,
     it is recommended to set a breakpoint on the following instruction.
  */
  //every 1ms 
  if (TIM2_GetFlagStatus(TIM2_FLAG_Update) == SET)
  {
    if (BuzzerTrigger == 1)
    {
      BuzzerTrigger = 0;
      if (BuzzerState == DISABLE)
      {
        if (ToneToggle == 0)
        {
          setSpeaker(params[2], params[1]);
          ToneToggle = 1;
        }
        else
        {
          setSpeaker(params[4], params[3]);
          ToneToggle = 0;
        }
        BuzzerCounter = 0;
        BuzzerState = ENABLE;
        TIM1_SetCounter(0);
        TIM1_CtrlPWMOutputs(BuzzerState);
      } 
    }
    else if (BuzzerState == ENABLE)
    {
      if (BuzzerCounter >= BuzzerTime)
      {
        BuzzerCounter = 0;
        BuzzerState = DISABLE; 
        TIM1_CtrlPWMOutputs(BuzzerState);
      }
      else 
      {
        BuzzerCounter++;
      }
      BuzzerTrigger = 0;
    }
    else
    {
        BuzzerCounter = 0;
        BuzzerState = DISABLE; 
        TIM1_CtrlPWMOutputs(BuzzerState);
    }
    
    TIM2_ClearITPendingBit(TIM2_IT_Update);
  }
}
```
First `if (BuzzerTrigger == 1)` branch handles events triggered by starting the tone - stting up volume, and frequency, fireing up the PWM output.

Second `else if (BuzzerState == ENABLE)` handles tone length check by checking if `(BuzzerCounter >= BuzzerTime)` condition and turns off the tone after given time.

Third, pure `else` branch is just a sanity check.

Params array stores all paramters. Importat ones in this scope, are:
Params[1] - First tone's frequency
Params[2] - First tone's volume
Params[3] - Second tone's frequency
Params[4] - Second tone's' volume

Note: In original code atached, there are some additional conditions which were removed from above examples in order to make them more readable.

